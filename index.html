<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gamelton AI</title>
  <style>
    body {margin:0; background:#0f1724; color:#fff; font-family:'Segoe UI',sans-serif; overflow:hidden;}/* Splash */
#splash {position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f1724; z-index:999;}
.title {font-size:52px; font-weight:bold; opacity:0; animation:fadeIn 2s forwards;}
.title span.ai {margin-left:8px; display:inline-block;
  background:linear-gradient(270deg, red, orange, yellow, green, cyan, blue, violet);
  background-size:400% 400%;
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  animation: spinGradient 2s linear infinite;
}
.subtitle {font-size:20px; margin-top:10px; opacity:0; animation:fadeUp 2s forwards 2.5s; color:#a78bfa;}
@keyframes fadeIn {to{opacity:1;}}
@keyframes fadeUp {from{opacity:0; transform:translateY(20px);}to{opacity:1; transform:translateY(0);}}
@keyframes spinGradient {0%{background-position:0% 50%;}100%{background-position:100% 50%;}}

.title span.ai.final {background:none; -webkit-text-fill-color:#a78bfa; animation:none;}

/* Intro */
#intro {position:fixed; inset:0; background:#0f1724; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:998; opacity:0; pointer-events:none; transition:opacity 1s;}
#intro.active {opacity:1; pointer-events:auto;}
#intro p {max-width:400px; text-align:center; font-size:18px; line-height:1.4; margin-bottom:20px;}
#intro button {padding:10px 20px; font-size:18px; background:#a78bfa; border:none; border-radius:8px; color:#fff; cursor:pointer; transition:background 0.3s;}
#intro button:hover {background:#7c3aed;}

/* App */
#app {display:none; flex-direction:column; height:100vh;}
#stage {position:relative; flex:1; overflow:hidden}
video, canvas {position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
video {transform:scaleX(-1)}

/* Controls */
#controls {position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
  display:flex; gap:12px; padding:10px 20px; border-radius:20px;
  background:rgba(255,255,255,0.1); backdrop-filter:blur(20px);
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
}
.btn {padding:10px 18px; font-size:16px; border:none; border-radius:14px; cursor:pointer;
  background:rgba(255,255,255,0.15); color:#fff; backdrop-filter:blur(20px);
  transition:all 0.3s;}
.btn.active {background:rgba(167,139,250,0.4); box-shadow:0 0 10px #a78bfa;}
.btn:hover {background:rgba(255,255,255,0.25);}

  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <div class="title">Gamelton <span class="ai">AI</span></div>
    <div class="subtitle">Camera Experience</div>
  </div>  <!-- Intro -->  <div id="intro">
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <b>Gamelton AI</b> ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:
      ‚úçÔ∏è –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤ –≤–æ–∑–¥—É—Ö–µ.<br>
      üòé AR-—Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ª–∏—Ü–∞.<br>
      üåÜ –ó–∞–º–µ–Ω–∞ —Ñ–æ–Ω–∞ —Å –ø–æ–º–æ—â—å—é AI.<br><br>
      –í—ã–±–∏—Ä–∞–π—Ç–µ —Ä–µ–∂–∏–º –∏ –ø—Ä–æ–±—É–π—Ç–µ!</p>
    <button id="startBtn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å</button>
  </div>  <!-- App -->  <div id="app">
    <div id="stage">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="draw"></canvas>
      <canvas id="overlay"></canvas>
    </div>
    <div id="controls">
      <button class="btn active" data-mode="draw">Draw</button>
      <button class="btn" data-mode="filters">Filters</button>
      <button class="btn" data-mode="background">Background</button>
      <button class="btn" id="save">üíæ</button>
    </div>
  </div>  <!-- MediaPipe -->  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>  <script>
    const splash=document.getElementById('splash');
    const intro=document.getElementById('intro');
    const app=document.getElementById('app');
    const video=document.getElementById('video');
    const canvas=document.getElementById('draw');
    const overlay=document.getElementById('overlay');
    const ctx=canvas.getContext('2d');
    const octx=overlay.getContext('2d');
    let mode="draw";

    setTimeout(()=>{document.querySelector('.title span.ai').classList.add('final');},3000);
    setTimeout(()=>{splash.style.display='none'; intro.classList.add('active');},4500);

    document.getElementById('startBtn').addEventListener('click',()=>{
      intro.style.display='none';
      app.style.display='flex';
      startApp();
    });

    function resize(){canvas.width=overlay.width=app.clientWidth; canvas.height=overlay.height=app.clientHeight-80;}
    window.addEventListener('resize',resize);

    // --- DRAW MODE ---
    let last=null;
    function detectGesture(lm){const tips=[8,12,16,20],mcp=[5,9,13,17];let ext=tips.map((t,i)=>lm[t].y<lm[mcp[i]].y);const c=ext.filter(v=>v).length;if(c===0)return'fist';if(ext[0]&&ext[1]&&!ext[2]&&!ext[3])return'two';if(ext[0]&&!ext[1]&&!ext[2]&&!ext[3])return'draw';return'none';}
    function drawLine(from,to,erase=false){ctx.save();ctx.globalCompositeOperation=erase?'destination-out':'source-over';ctx.strokeStyle=erase?'rgba(0,0,0,1)':'#ff4655';ctx.lineWidth=erase?40:6;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(from.x,from.y);ctx.lineTo(to.x,to.y);ctx.stroke();ctx.restore();}
    function norm(p){return{x:p.x*canvas.width,y:p.y*canvas.height};}

    // --- FILTER MODE (FaceMesh) ---
    function renderFilters(lm){if(!lm) return;drawConnectors(octx,lm,FACEMESH_TESSELATION,{color:'rgba(0,255,255,0.3)',lineWidth:0.5});}

    // --- BACKGROUND MODE ---
    let segmentationMask=null;
    function renderBackground(results){if(!results.segmentationMask)return; octx.save(); octx.clearRect(0,0,overlay.width,overlay.height); octx.drawImage(results.segmentationMask,0,0,overlay.width,overlay.height); octx.globalCompositeOperation='source-in'; octx.fillStyle='rgba(100,0,200,0.5)'; octx.fillRect(0,0,overlay.width,overlay.height); octx.restore();}

    // MediaPipe pipelines
    const hands=new Hands({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.5});
    hands.onResults(res=>{if(mode!=='draw'){return;}octx.clearRect(0,0,overlay.width,overlay.height);if(res.multiHandLandmarks&&res.multiHandLandmarks.length>0){const lm=res.multiHandLandmarks[0];const g=detectGesture(lm);if(g==='draw'){const tip=norm(lm[8]);if(last)drawLine(last,tip,false);last=tip;}else if(g==='fist'){const tip=norm(lm[8]);if(last)drawLine(last,tip,true);last=tip;}else if(g==='two'){ctx.clearRect(0,0,canvas.width,canvas.height);last=null;}else last=null;}});

    const faceMesh=new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({maxNumFaces:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
    faceMesh.onResults(res=>{if(mode!=='filters'){return;}octx.clearRect(0,0,overlay.width,overlay.height);if(res.multiFaceLandmarks)res.multiFaceLandmarks.forEach(renderFilters);});

    const selfieSeg=new SelfieSegmentation({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
    selfieSeg.setOptions({modelSelection:1});
    selfieSeg.onResults(res=>{if(mode!=='background'){return;}renderBackground(res);});

    function startApp(){resize();
      const camera=new Camera(video,{onFrame:async()=>{
        if(mode==='draw') await hands.send({image:video});
        else if(mode==='filters') await faceMesh.send({image:video});
        else if(mode==='background') await selfieSeg.send({image:video});
      },width:640,height:480});
      camera.start();
    }

    // Mode switch
    document.querySelectorAll('#controls .btn[data-mode]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        mode=btn.dataset.mode;
        document.querySelectorAll('#controls .btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        octx.clearRect(0,0,overlay.width,overlay.height);
      });
    });

    // Save
    document.getElementById('save').addEventListener('click',()=>{
      const out=document.createElement('canvas'); out.width=canvas.width; out.height=canvas.height;
      const octx2=out.getContext('2d');
      octx2.drawImage(video,0,0,out.width,out.height);
      octx2.drawImage(canvas,0,0,out.width,out.height);
      octx2.drawImage(overlay,0,0,out.width,out.height);
      const a=document.createElement('a'); a.href=out.toDataURL('image/png'); a.download='gamelton-ai.png'; a.click();
    });
  </script></body>
</html>    function attachDrawingHandlers(){
      canvas.addEventListener('pointerdown', pointerDown);
      canvas.addEventListener('pointermove', pointerMove);
      window.addEventListener('pointerup', pointerUp);

      // –î–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ —Ç–∞—á–µ–π
      canvas.addEventListener('touchstart', pointerDown, {passive:false});
      canvas.addEventListener('touchmove', pointerMove, {passive:false});
      canvas.addEventListener('touchend', pointerUp);
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
    async function getCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = '';
        cams.forEach((c,i)=>{
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.textContent = c.label || `–ö–∞–º–µ—Ä–∞ ${i+1}`;
          cameraSelect.appendChild(opt);
        });
      }catch(err){console.warn(err)}
    }

    async function startCamera(deviceId){
      if (currentStream){
        currentStream.getTracks().forEach(t=>t.stop());
        currentStream = null;
      }
      const constraints = {
        video: deviceId ? {deviceId:{exact:deviceId}} : {facingMode:'environment'},
        audio: false
      };
      try{
        status.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...';
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        await video.play();
        status.textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';

        // –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
        resize();
      }catch(err){
        console.error(err);
        status.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –º—ã —Ä–∏—Å—É–µ–º –∫–∞–¥—Ä –≤–∏–¥–µ–æ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–º canvas, –∑–∞—Ç–µ–º –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º —Ä–∏—Å—É–Ω–æ–∫
    function saveImage(){
      const out = document.createElement('canvas');
      out.width = canvas.width; out.height = canvas.height;
      const octx = out.getContext('2d');
      // –í–∞–∂–Ω–æ: –≤–∏–¥–µ–æ –∏–º–µ–µ—Ç transform:scaleX(-1) –¥–ª—è –∑–µ—Ä–∫–∞–ª–∞, —É—á—Ç–µ–º —ç—Ç–æ
      octx.save();
      // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ devicePixelRatio
      const ratio = window.devicePixelRatio || 1;
      octx.scale(ratio, ratio);
      // –ù–∞—Ä–∏—Å—É–µ–º –≤–∏–¥–µ–æ (–Ω–µ –∑–µ—Ä–∫–∞–ª—å–Ω–æ) ‚Äî –µ—Å–ª–∏ page –∑–µ—Ä–∫–∞–ª–µ–Ω, —Ç–æ –ø–µ—Ä–µ–≤–µ—Ä–Ω—ë–º
      const stageRect = canvas.getBoundingClientRect();
      // drawImage –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∏–∫—Å–µ–ª—è—Ö, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º video.videoWidth/video.videoHeight
      // –ß—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ –≤ canvas, –∏—Å–ø–æ–ª—å–∑—É–µ–º cover-like drawing
      const vw = video.videoWidth, vh = video.videoHeight;
      const cw = stageRect.width, ch = stageRect.height;
      // compute source rect to cover
      const videoRatio = vw/vh; const canvasRatio = cw/ch;
      let sx=0, sy=0, sw=vw, sh=vh;
      if (videoRatio > canvasRatio){
        // video wider -> crop sides
        const desiredW = vh * canvasRatio;
        sx = (vw - desiredW)/2; sw = desiredW;
      } else {
        // video taller -> crop top/bottom
        const desiredH = vw / canvasRatio;
        sy = (vh - desiredH)/2; sh = desiredH;
      }
      // —É—á–∏—Ç—ã–≤–∞–µ–º –∑–µ—Ä–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      const mirrored = getComputedStyle(video).transform.includes('-1') || getComputedStyle(video).transform.includes('scaleX(-1)');
      if (mirrored) {
        octx.translate(cw, 0);
        octx.scale(-1,1);
      }
      octx.drawImage(video, sx, sy, sw, sh, 0, 0, cw, ch);
      octx.restore();

      // –∑–∞—Ç–µ–º –Ω–∞–ª–æ–∂–∏–º —Ä–∏—Å—É–Ω–æ–∫ (canvas) ‚Äî –Ω–æ remember canvas is already scaled to DPR, so draw full size
      octx.drawImage(canvas, 0, 0, out.width, out.height);

      // —Ñ–æ—Ä–º–∏—Ä—É–µ–º dataURL –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      const data = out.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = data; a.download = 'camera-draw.png';
      document.body.appendChild(a); a.click(); a.remove();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
    (async function init(){
      attachDrawingHandlers();
      window.addEventListener('resize', resize);

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        status.textContent = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç getUserMedia.';
        return;
      }

      await getCameras();
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É (–ø–æ–ø—ã—Ç–∫–∞ —Å–Ω–∞—á–∞–ª–∞ environment)
      await startCamera();

      // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å –∏ –¥–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å
      cameraSelect.addEventListener('change', ()=>{
        startCamera(cameraSelect.value);
      });

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
      eraserBtn.addEventListener('click', ()=>{
        isEraser = !isEraser; eraserBtn.textContent = isEraser ? '–ö–∞—Ä–∞–Ω–¥–∞—à' : '–õ–∞—Å—Ç–∏–∫';
      });
      clearBtn.addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); });
      saveBtn.addEventListener('click', saveImage);

      toggleMirrorBtn.addEventListener('click', ()=>{
        const mirrored = video.style.transform === 'scaleX(-1)';
        if (mirrored){ video.style.transform = 'scaleX(1)'; toggleMirrorBtn.textContent = '–ó–µ—Ä–∫–∞–ª–æ: –í—ã–∫–ª'; }
        else { video.style.transform = 'scaleX(-1)'; toggleMirrorBtn.textContent = '–ó–µ—Ä–∫–∞–ª–æ: –í–∫–ª'; }
      });

      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      document.body.addEventListener('touchmove', function(e){ if (e.target === canvas) e.preventDefault(); }, {passive:false});

      // –ù–∞—á–∞–ª—å–Ω–æ–µ —Ä–µ—Å–∞–π–∑
      setTimeout(resize, 250);
    })();
  </script></body>
</html>
