<script>
    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤–∏–¥–µ–æ
    let videos = JSON.parse(localStorage.getItem('mytube_videos')) || [];
    let currentVideoId = null;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadModal = document.getElementById('uploadModal');
    const closeModal = document.getElementById('closeModal');
    const cancelUpload = document.getElementById('cancelUpload');
    const uploadForm = document.getElementById('uploadForm');
    const videosGrid = document.getElementById('videosGrid');
    const homeView = document.getElementById('homeView');
    const videoView = document.getElementById('videoView');
    const backBtn = document.getElementById('backBtn');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoTitleLarge = document.getElementById('videoTitleLarge');
    const videoStats = document.getElementById('videoStats');
    const likesCount = document.getElementById('likesCount');
    const videoDescription = document.getElementById('videoDescription');
    const editStatsBtn = document.getElementById('editStatsBtn');
    const statsEditForm = document.getElementById('statsEditForm');
    const saveStatsBtn = document.getElementById('saveStatsBtn');
    const editViews = document.getElementById('editViews');
    const editLikes = document.getElementById('editLikes');
    const editComments = document.getElementById('editComments');

    const likeBtn = document.getElementById('likeBtn');

    // –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
    const videoProgressBar = document.getElementById('videoProgressBar');
    const videoProgress = document.getElementById('videoProgress');
    const videoStatus = document.getElementById('videoStatus');
    const thumbnailProgressBar = document.getElementById('thumbnailProgressBar');
    const thumbnailProgress = document.getElementById('thumbnailProgress');
    const thumbnailStatus = document.getElementById('thumbnailStatus');

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    uploadBtn.addEventListener('click', () => uploadModal.style.display = 'flex');
    closeModal.addEventListener('click', closeUploadModal);
    cancelUpload.addEventListener('click', closeUploadModal);

    function closeUploadModal() {
        uploadModal.style.display = 'none';
        resetUploadForm();
    }

    function resetUploadForm() {
        uploadForm.reset();
        videoProgressBar.style.display = 'none';
        videoStatus.style.display = 'none';
        thumbnailProgressBar.style.display = 'none';
        thumbnailStatus.style.display = 'none';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const videoFile = document.getElementById('videoFile').files[0];
        const thumbnailFile = document.getElementById('thumbnailFile').files[0];
        const title = document.getElementById('videoTitle').value;
        const description = document.getElementById('videoDescriptionInput').value;
        const views = parseInt(document.getElementById('initialViews').value) || 0;
        const likes = parseInt(document.getElementById('initialLikes').value) || 0;
        const comments = parseInt(document.getElementById('initialComments').value) || 0;
        const uploadDateInput = document.getElementById('uploadDate').value;
        const uploadDate = uploadDateInput ? new Date(uploadDateInput).toISOString() : new Date().toISOString();

        if (!videoFile) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª');
            return;
        }

        try {
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≤–∏–¥–µ–æ
            const newVideo = {
                id: Date.now().toString(),
                title,
                description,
                views,
                likes,
                comments,
                uploadDate
            };

            // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
            videoProgressBar.style.display = 'block';
            videoStatus.style.display = 'block';
            videoStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...';
            newVideo.videoUrl = await readFileWithProgress(videoFile, (p) => {
                videoProgress.style.width = `${p}%`;
                videoStatus.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ: ${Math.round(p)}%`;
            });
            videoStatus.textContent = '–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!';

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é
            if (thumbnailFile) {
                thumbnailProgressBar.style.display = 'block';
                thumbnailStatus.style.display = 'block';
                thumbnailStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é...';
                newVideo.thumbnailUrl = await readFileWithProgress(thumbnailFile, (p) => {
                    thumbnailProgress.style.width = `${p}%`;
                    thumbnailStatus.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é: ${Math.round(p)}%`;
                });
                thumbnailStatus.textContent = '–ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ!';
            } else {
                newVideo.thumbnailUrl = null;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ
            videos.push(newVideo);
            localStorage.setItem('mytube_videos', JSON.stringify(videos));
            renderVideos();

            setTimeout(() => {
                closeUploadModal();
            }, 500);

        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
        }
    });

    // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
    function readFileWithProgress(file, callback) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadstart = () => callback(0);
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    callback((e.loaded / e.total) * 100);
                }
            };
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => reject('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            reader.readAsDataURL(file);
        });
    }

    // –†–µ–Ω–¥–µ—Ä —Å–µ—Ç–∫–∏ –≤–∏–¥–µ–æ
    function renderVideos() {
        if (videos.length === 0) {
            videosGrid.innerHTML = `
                <div class="empty-state">
                    <i>üìπ</i>
                    <h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</h3>
                    <p>–ù–∞—á–Ω–∏—Ç–µ —Å –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –≤–∏–¥–µ–æ</p>
                </div>
            `;
            return;
        }

        videosGrid.innerHTML = videos.map(video => `
            <div class="video-card" data-id="${video.id}">
                <div class="thumbnail-container">
                    <img src="${video.thumbnailUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMjAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMjgyODI4Ii8+CjxwYXRoIGQ9Ik0xMzQgODcuNUwxMTIgOTlWNzZMMTM0IDg3LjVaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K'}" alt="${video.title}" class="thumbnail">
                    <div class="video-duration">10:00</div>
                </div>
                <div class="video-info">
                    <div class="channel-icon">–ú</div>
                    <div class="video-details">
                        <div class="video-title">${video.title}</div>
                        <div class="video-stats">
                            <div>–ú–æ–π –∫–∞–Ω–∞–ª</div>
                            <div>${formatNumber(video.views)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ ${formatDate(video.uploadDate)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        document.querySelectorAll('.video-card').forEach(card => {
            card.addEventListener('click', () => playVideo(card.dataset.id));
        });
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ
    function playVideo(videoId) {
        const video = videos.find(v => v.id === videoId);
        if (!video) return;
        currentVideoId = videoId;

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
        video.views++;
        localStorage.setItem('mytube_videos', JSON.stringify(videos));

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥
        homeView.style.display = 'none';
        videoView.style.display = 'block';

        videoPlayer.innerHTML = `<video controls autoplay><source src="${video.videoUrl}" type="video/mp4">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.</video>`;
        videoTitleLarge.textContent = video.title;
        updateVideoStats(video);
        videoDescription.textContent = video.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
        likesCount.textContent = video.likes;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateVideoStats(video) {
        videoStats.innerHTML = `<div>${formatNumber(video.views)} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ ${formatDate(video.uploadDate)}</div>`;
    }

    // –§–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞
    function formatNumber(num) {
        if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + ' –º–ª–Ω';
        if (num >= 1_000) return (num / 1_000).toFixed(1) + ' —Ç—ã—Å';
        return num.toString();
    }

    // –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã "x –º–∏–Ω—É—Ç/—á–∞—Å–æ–≤/–¥–Ω–µ–π –Ω–∞–∑–∞–¥"
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMinutes < 60) return `${diffMinutes} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥`;
        if (diffHours < 24) return `${diffHours} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥`;
        if (diffDays < 7) return `${diffDays} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} –Ω–µ–¥–µ–ª—å –Ω–∞–∑–∞–¥`;
        return `${Math.floor(diffDays / 30)} –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥`;
    }

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    backBtn.addEventListener('click', () => {
        videoView.style.display = 'none';
        homeView.style.display = 'block';
        renderVideos();
    });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    editStatsBtn.addEventListener('click', () => {
        const isVisible = statsEditForm.style.display === 'block';
        statsEditForm.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            const video = videos.find(v => v.id === currentVideoId);
            if (video) {
                editViews.value = video.views;
                editLikes.value = video.likes;
                editComments.value = video.comments;
            }
        }
    });

    saveStatsBtn.addEventListener('click', () => {
        const video = videos.find(v => v.id === currentVideoId);
        if (video) {
            video.views = parseInt(editViews.value) || 0;
            video.likes = parseInt(editLikes.value) || 0;
            video.comments = parseInt(editComments.value) || 0;

            localStorage.setItem('mytube_videos', JSON.stringify(videos));
            updateVideoStats(video);
            likesCount.textContent = video.likes;
            statsEditForm.style.display = 'none';
            renderVideos();
        }
    });

    // –õ–∞–π–∫ –≤–∏–¥–µ–æ
    likeBtn.addEventListener('click', () => {
        const video = videos.find(v => v.id === currentVideoId);
        if (video) {
            video.likes++;
            localStorage.setItem('mytube_videos', JSON.stringify(videos));
            likesCount.textContent = video.likes;
            renderVideos();
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', renderVideos);
</script>

